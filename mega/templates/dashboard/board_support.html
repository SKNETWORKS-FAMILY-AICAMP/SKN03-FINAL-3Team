{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MeGA DASHBOARD</title>
  <link href="{% static 'img/mega.png' %}" rel="icon" type="image/png">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="{% static 'css/nucleo.css' %}">
  <link rel="stylesheet" href="{% static 'css/all.min.css.css' %}">
  <!-- Argon CSS -->
  <link rel="stylesheet" href="{% static 'css/argon-dashboard.css' %}">
  <style>
    .navbar-vertical .navbar-brand {
      padding-top: 0.5rem !important; 
      padding-bottom: 0.5rem !important;
      margin: 0 !important;
    }
    .navbar-vertical .navbar-brand-img {
      max-height: 6rem !important; 
      height: auto !important;
      width: auto !important;
      margin: 0 !important;
    }
  </style>
</head>

<body class="">
  <!-- 사이드바 -->
  <nav class="navbar navbar-vertical fixed-left navbar-expand-md navbar-light bg-white" id="sidenav-main">
    <div class="container-fluid">
      <!-- 토글(모바일) -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#sidenav-collapse-main">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- 브랜드 로고 -->
      <a class="navbar-brand pt-0" href="{% url 'board_dev' %}">
        <img src="{% static 'img/mega.png' %}" class="navbar-brand-img" alt="MeGA">
      </a>

      <!-- 모바일 화면 User -->
      <ul class="nav align-items-center d-md-none">
        <li class="nav-item dropdown">
          {% if user.is_authenticated %}
          <a class="nav-link" href="#" role="button" data-toggle="dropdown">
            <div class="media align-items-center">
              <span class="avatar avatar-sm rounded-circle">
                <img alt="Image placeholder" src="{{ user.socialaccount_set.first.get_avatar_url|default:'your_default_image_url' }}">
              </span>
            </div>
          </a>
          <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
            <div class="dropdown-header noti-title">
              <h6 class="text-overflow m-0">Welcome!</h6>
            </div>
            <a href="./examples/profile.html" class="dropdown-item">
              <i class="ni ni-single-02"></i>
              <span>{{ user.get_full_name|default:user.username }}</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="{% url 'logout' %}" class="dropdown-item">
              <i class="ni ni-user-run"></i>
              <span>Logout</span>
            </a>
          </div>
          {% endif %}
        </li>
      </ul>

      <!-- 사이드바 메뉴 -->
      <div class="collapse navbar-collapse" id="sidenav-collapse-main">
        <div class="navbar-collapse-header d-md-none">
          <div class="row">
            <div class="col-6 collapse-brand">
              <a href="{% url 'board_dev' %}">
                <img src="{% static 'img/mega.png' %}">
              </a>
            </div>
            <div class="col-6 collapse-close">
              <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#sidenav-collapse-main">
                <span></span>
                <span></span>
              </button>
            </div>
          </div>
        </div>
        <!-- Search (모바일) -->
        <form class="mt-4 mb-3 d-md-none">
          <div class="input-group input-group-rounded input-group-merge">
            <input class="form-control form-control-rounded form-control-prepended" placeholder="Search" type="search">
            <div class="input-group-prepend">
              <div class="input-group-text">
                <span class="fa fa-search"></span>
              </div>
            </div>
          </div>
        </form>
        <!-- 네비게이션 메뉴 -->
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="{% url 'board_dev' %}">
            <i class="ni ni-tv-2 text-primary"></i> 개발부</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'board_marketing' %}">
            <i class="ni ni-pin-3 text-orange"></i> 마케팅부</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'board_sales' %}">
            <i class="ni ni-single-02 text-yellow"></i> 영업부</a></li>
          <li class="nav-item active"><a class="nav-link active" href="{% url 'board_support' %}">
            <i class="ni ni-bullet-list-67 text-red"></i> 지원부</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'board_accounting' %}">
            <i class="ni ni-key-25 text-info"></i> 재무부</a></li>
          <hr class="my-3">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'board_calendar' %}">
              <i class="ni ni-circle-08 text-pink"></i> 캘린더
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 메인 콘텐츠 -->
  <div class="main-content">
    <!-- 상단 Navbar -->
    <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
      <div class="container-fluid">
        <a class="h4 mb-0 text-white text-uppercase d-none d-lg-inline-block" href="#">Dashboard</a>
        <ul class="navbar-nav align-items-center d-none d-md-flex">
          {% if user.is_authenticated %}
          <li class="nav-item dropdown">
            <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown">
              <div class="media align-items-center">
                <span class="avatar avatar-sm rounded-circle">
                  <img alt="Image placeholder" src="{{ user.socialaccount_set.first.get_avatar_url|default:'your_default_image_url' }}">
                </span>
                <div class="media-body ml-2 d-none d-lg-block">
                  <span class="mb-0 text-sm font-weight-bold">
                    {{ user.get_full_name|default:user.username }}
                  </span>
                </div>
              </div>
            </a>
            <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
              <div class="dropdown-header noti-title">
                <h6 class="text-overflow m-0">Welcome!</h6>
              </div>
              <a href="./examples/profile.html" class="dropdown-item">
                <i class="ni ni-single-02"></i>
                <span>My profile</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="{% url 'logout' %}" class="dropdown-item">
                <i class="ni ni-user-run"></i>
                <span>Logout</span>
              </a>
            </div>
          </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    <!-- 헤더 -->
    <div class="header bg-gradient-primary pb-8 pt-5 pt-md-8"></div>

    <div class="container-fluid mt--7">
      <!-- 주별 질문 통계 -->
      <div class="row">
        <div class="col-xl-5 mb-5">
          <div class="card bg-gradient-default shadow">
            <div class="card-header bg-transparent">
              <h6 class="text-uppercase text-light ls-1 mb-1">지원부</h6>
              <h2 class="text-white mb-0">주별 질문 통계</h2>
            </div>
            <div class="card-body">
              <div class="chart">
                <canvas id="myChart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- 월별 키워드 Top5 (Polar Chart) -->
        <div class="col-xl-3">
          <div class="card shadow">
            <div class="card-header bg-transparent">
              <!-- 첫째 줄 -->
              <h6 class="text-uppercase text-muted ls-1 mb-1">월별</h6>
              <!-- 둘째 줄: h2 + 버튼 한 줄 -->
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">질문 키워드 TOP5</h2>
                <div class="d-flex align-items-center">
                  <!-- 이전달 버튼 -->
                  <a
                    href="?kyear={{ k_prev_year }}&kmonth={{ k_prev_month }}"
                    class="btn btn-sm btn-outline-primary mr-2"
                  >
                    &lt;
                  </a>
                  <span class="mx-1 text-primary" style="font-weight:600;">
                    {{ kmonth }}월
                  </span>
                  {% if next_k_disabled %}
                    <button class="btn btn-sm btn-outline-secondary ml-2" disabled>&gt;</button>
                  {% else %}
                    <a
                      href="?kyear={{ k_next_year }}&kmonth={{ k_next_month }}"
                      class="btn btn-sm btn-outline-primary ml-2"
                    >
                      &gt;
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="chart">
                <canvas id="keywordPolarChart" width="300" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- 반려 질문 목록 -->
        <div class="col-xl-4">
          <div class="card shadow">
            <div class="card-header bg-transparent">
              <h6 class="text-uppercase text-muted ls-1 mb-1">
                {{ this_year }}-{{ this_month }}
              </h6>
              <h2 class="mb-0">미응답 질문 목록</h2>
            </div>
            <div class="card-body" style="height:400px; overflow-y:auto;">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th style="width:40px;">#</th>
                      <th>Question</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in rejected_questions %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td style="white-space: pre-line; line-height:1.2;">
                        {{ item.question }}
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="2">이번 달 반려 질문이 없습니다.</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 인사현황 테이블 -->
      <div class="row mt-5">
        <div class="col-xl-12">
          <div class="card shadow">
            <div class="card-header border-0 d-flex justify-content-between">
              <h2>지원부 인사현황</h2>
              <div style="width: 300px;">
                <input type="text" id="searchInput" class="form-control form-control-sm"
                       placeholder="사번 또는 이름 검색">
              </div>
            </div>
            <div class="table-responsive">
              <table class="table align-items-center table-flush" id="employeeTable">
                <thead class="thead-light">
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Team</th>
                    <th>Role</th>
                    <th>Contact</th>
                    <th>Email</th>

                    <!-- Tardies_Month 정렬 -->
                    <th>
                      {% if sort_col == "7" and sort_dir == "desc" %}
                        <a href="?sort_col=7&sort_dir=asc">Tardies_Month ▼</a>
                      {% elif sort_col == "7" and sort_dir == "asc" %}
                        <a href="?sort_col=7&sort_dir=desc">Tardies_Month ▲</a>
                      {% else %}
                        <a href="?sort_col=7&sort_dir=desc">Tardies_Month</a>
                      {% endif %}
                    </th>

                    <!-- Tardies 정렬 -->
                    <th>
                      {% if sort_col == "8" and sort_dir == "desc" %}
                        <a href="?sort_col=8&sort_dir=asc">Tardies ▼</a>
                      {% elif sort_col == "8" and sort_dir == "asc" %}
                        <a href="?sort_col=8&sort_dir=desc">Tardies ▲</a>
                      {% else %}
                        <a href="?sort_col=8&sort_dir=desc">Tardies</a>
                      {% endif %}
                    </th>

                    <!-- Absences 정렬 -->
                    <th>
                      {% if sort_col == "9" and sort_dir == "desc" %}
                        <a href="?sort_col=9&sort_dir=asc">Absences ▼</a>
                      {% elif sort_col == "9" and sort_dir == "asc" %}
                        <a href="?sort_col=9&sort_dir=desc">Absences ▲</a>
                      {% else %}
                        <a href="?sort_col=9&sort_dir=desc">Absences</a>
                      {% endif %}
                    </th>

                    <!-- Leave_Left 정렬 -->
                    <th>
                      {% if sort_col == "10" and sort_dir == "desc" %}
                        <a href="?sort_col=10&sort_dir=asc">Leave_Left ▼</a>
                      {% elif sort_col == "10" and sort_dir == "asc" %}
                        <a href="?sort_col=10&sort_dir=desc">Leave_Left ▲</a>
                      {% else %}
                        <a href="?sort_col=10&sort_dir=desc">Leave_Left</a>
                      {% endif %}
                    </th>

                    <th>Total_Leave</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in page_obj %}
                  <tr>
                    <td>{{ row.employee_id }}</td>
                    <td>{{ row.name }}</td>
                    <td>{{ row.team_id }}</td>
                    <td>{{ row.rank }}</td>
                    <td>{{ row.phone_number }}</td>
                    <td>{{ row.email }}</td>
                    <td class="text-center">{{ row.monthly_late_days }}</td>
                    <td class="text-center">{{ row.total_late_days }}</td>
                    <td class="text-center">{{ row.total_absence_days }}</td>
                    <td class="text-center">{{ row.remaining_annual_leave }}</td>
                    <td class="text-center">{{ row.total_annual_leave }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>

              <!-- 페이지네이션 -->
              <div class="d-flex justify-content-center mt-3">
                <nav aria-label="Page navigation example">
                  <ul class="pagination justify-content-center">
                    <!-- 이전 버튼 -->
                    {% if page_obj.has_previous %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}"
                           aria-label="Previous">
                          <span aria-hidden="true">&laquo;</span>
                        </a>
                      </li>
                    {% else %}
                      <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                          <span aria-hidden="true">&laquo;</span>
                        </a>
                      </li>
                    {% endif %}

                    {% for i in page_obj.paginator.page_range %}
                      <!-- 첫 페이지 또는 마지막 페이지 -->
                      {% if i == 1 or i == page_obj.paginator.num_pages %}
                        {% if i == page_obj.number %}
                          <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                        {% else %}
                          <li class="page-item">
                            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                          </li>
                        {% endif %}
                      {% elif i >= page_obj.number|add:-2 and i <= page_obj.number|add:2 %}
                        {% if i == page_obj.number %}
                          <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                        {% else %}
                          <li class="page-item">
                            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                          </li>
                        {% endif %}
                      {% elif i == 2 or i == page_obj.paginator.num_pages|add:-1 %}
                        <li class="page-item disabled">
                          <span class="page-link">…</span>
                        </li>
                      {% endif %}
                    {% endfor %}

                    <!-- 다음 버튼 -->
                    {% if page_obj.has_next %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}"
                           aria-label="Next">
                          <span aria-hidden="true">&raquo;</span>
                        </a>
                      </li>
                    {% else %}
                      <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                          <span aria-hidden="true">&raquo;</span>
                        </a>
                      </li>
                    {% endif %}
                  </ul>
                </nav>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="footer">
        <div class="row align-items-center justify-content-xl-between">
          <div class="col-xl-6">
            <div class="copyright text-center text-xl-left text-muted">
              &copy; 2018
              <a href="https://www.creative-tim.com" class="font-weight-bold ml-1" target="_blank">
                Creative Tim
              </a>
            </div>
          </div>
          <div class="col-xl-6">
            <ul class="nav nav-footer justify-content-center justify-content-xl-end">
              <li class="nav-item">
                <a href="https://www.creative-tim.com" class="nav-link" target="_blank">Creative Tim</a>
              </li>
              <li class="nav-item">
                <a href="https://www.creative-tim.com/presentation" class="nav-link" target="_blank">About Us</a>
              </li>
              <li class="nav-item">
                <a href="http://blog.creative-tim.com" class="nav-link" target="_blank">Blog</a>
              </li>
              <li class="nav-item">
                <a href="https://github.com/creativetimofficial/argon-dashboard/blob/master/LICENSE.md"
                   class="nav-link" target="_blank">
                  MIT License
                </a>
              </li>
            </ul>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Core JS -->
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      Dropdown();
      Collapse("#sidenav-collapse-main");
    });
  </script>

  <!-- 검색 (사번,이름) 필터링 -->
  <script>
    function debounce(fn, delay = 300) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("searchInput");
      const tableBody = document.querySelector("#employeeTable tbody");
      const tableRows = tableBody.querySelectorAll("tr");

      function filterTable() {
        const query = searchInput.value.trim().toLowerCase();
        tableRows.forEach((row) => {
          const idCell = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
          const nameCell= row.querySelector("td:nth-child(2)").textContent.toLowerCase();
          if (idCell.includes(query) || nameCell.includes(query)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }
      const debouncedFilter = debounce(filterTable, 300);
      searchInput.addEventListener("input", debouncedFilter);
    });
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript">
    // Django 템플릿 변수 -> JS
    var labels = {{ labels|safe }};
    var teamQuestions = {{ team_questions|safe }};
    var otherQuestions = {{ other_questions|safe }};

    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: '지원부 질문 수',
            data: teamQuestions,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            stack: 'questions',
          },
          {
            label: '기타 질문 수',
            data: otherQuestions,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            stack: 'questions',
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            stacked: true,
            ticks: {
              color: 'rgb(142,147,153)'
            }
          },
          y: {
            stacked: true,
            beginAtZero: true,
            ticks: {
              color: 'rgb(163,177,193)'
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: 'rgb(142,147,153)'
            }
          }
        }
      }
    });
  </script>

  <!-- Polar Chart (키워드) -->
  <script>
    var polarLabels = {{ keyword_labels|safe }};
    var polarValues = {{ keyword_values|safe }};

    document.addEventListener("DOMContentLoaded", function() {
      const ctxPolar = document.getElementById('keywordPolarChart').getContext('2d');
      const polarChart = new Chart(ctxPolar, {
        type: 'polarArea',
        data: {
          labels: polarLabels,
          datasets: [{
            label: 'Keyword Frequency',
            data: polarValues,
            backgroundColor: [
              'rgba(255, 99, 132, 0.5)',
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 206, 86, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
    });
  </script>

  <!-- Optional Argon JS -->
  <script src="./assets/js/plugins/chart.js/dist/Chart.min.js"></script>
  <script src="./assets/js/plugins/chart.js/dist/Chart.extension.js"></script>
  <script src="./assets/js/argon-dashboard.min.js?v=1.1.2"></script>
  <script src="https://cdn.trackjs.com/agent/v3/latest/t.js"></script>
  <script>
    window.TrackJS &&
      TrackJS.install({
        token: "ee6fab19c5a04ac1a32a645abde4613a",
        application: "argon-dashboard-free"
      });
  </script>
</body>
</html>
